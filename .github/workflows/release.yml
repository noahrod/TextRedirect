name: Build and Release APK

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v0.80, v1.0.0, etc.
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Build Release APK
        run: ./gradlew assembleRelease
      
      - name: Sign APK
        uses: r0adkll/sign-android-release@v1
        id: sign_app
        with:
          releaseDirectory: app/build/outputs/apk/release
          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
          alias: ${{ secrets.ALIAS }}
          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}
        env:
          BUILD_TOOLS_VERSION: "34.0.0"
      
      - name: Rename APK
        run: |
          VERSION_TAG=${GITHUB_REF#refs/tags/}
          mv ${{steps.sign_app.outputs.signedReleaseFile}} TextRedirect-${VERSION_TAG}.apk
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: TextRedirect-*.apk
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## ðŸ“± TextRedirect ${{ github.ref_name }}
            
            ### Installation
            1. Download the APK below
            2. Enable "Install from Unknown Sources" in your Android settings
            3. Install the APK
            4. Grant notification access in Settings
            5. Sign in with Google and enable SMS forwarding
            
            ### What's Changed
            See the automatically generated release notes below.
            
            ---
            
            **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
